# Какой ip адрес отображается в логах контроллера при использовании TrafficPolicy Cluster

## Описание.
По логике должен отображаться не адрес источника запроса. Провреим эту гипотезу.

## Поехали!
Установим Ingress контроллер c включённой TrafficPolicy: Cluster и задеплоим приложение с сервисом и ингрессом.
```
helm upgrade --install ingress-nginx ingress-nginx \
--repo https://kubernetes.github.io/ingress-nginx \
--namespace ingress-nginx --create-namespace \
--debug \
--set controller.ingressClass="nginx" \
--set controller.ingressClassResource.name="nginx" \
--set controller.ingressClassResource.enabled=true \
--set controller.ingressClassByName=true \
--set controller.publishService.enabled=true \
--set controller.admissionWebhooks.enabled=false \
--set controller.service.externalTrafficPolicy="Cluster" \
--set controller.replicaCount=1 \
--set controller.service.sessionAffinity="None"
```

### Задеплоим приложение.
https://github.com/Cameda/public_solutions/blob/main/kubernetes_extended/ingress-nginx/example/one_ingress_with_one_backend.yaml

### Проверяем свой адрес.
curl ifconfig.me
93.158.190.119

### Запустим curl в бесконечном цикле.
```
while true
do
    curl -s http://cat.cameda1.ru
    sleep 1
done
```

### Проверка.
Смотрим в логах пода ингресс контроллера.
```
10.143.0.13 - - [25/Apr/2025:11:38:55 +0000] "GET / HTTP/1.1" 200 615 "-" "curl/8.7.1" 77 0.000 [default-cam-svc-test-one-80] [] 10.5.128.10:80 615 0.000 200 c8afaf78a0e57b7ee861a9b220e356b7
10.143.0.13 - - [25/Apr/2025:11:38:56 +0000] "GET / HTTP/1.1" 200 615 "-" "curl/8.7.1" 77 0.000 [default-cam-svc-test-one-80] [] 10.5.128.10:80 615 0.001 200 cb161eb8b26dc074da682f52817ef025
10.143.0.13 - - [25/Apr/2025:11:38:57 +0000] "GET / HTTP/1.1" 200 615 "-" "curl/8.7.1" 77 0.000 [default-cam-svc-test-one-80] [] 10.5.128.10:80 615 0.001 200 43ae9fe1dff1002bb105f81e1be2c9db
10.143.0.13 - - [25/Apr/2025:11:38:58 +0000] "GET / HTTP/1.1" 200 615 "-" "curl/8.7.1" 77 0.001 [default-cam-svc-test-one-80] [] 10.5.128.10:80 615 0.000 200 3ea36f7ee0d9af3fdd8e414e7bb86c20
10.143.0.13 - - [25/Apr/2025:11:38:59 +0000] "GET / HTTP/1.1" 200 615 "-" "curl/8.7.1" 77 0.000 [default-cam-svc-test-one-80] [] 10.5.128.10:80 615 0.000 200 ba65cbb28318b738264e3be30330b550
```

## Результат.
В логах отображается внутренний адрес ноды. Маскарадинг работает. 
Данное применимо к кластерам с CNI Calico. В Cilium маскарадинг работает с перебоями.
